<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>日日清單 (雲端版)</title>
    
    <!-- PWA -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#FEF9E7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="icon.png">

    <!-- 庫 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root { --bg-kaisa: #FEF9E7; --line-color: #E8E0C5; }
        body { background-color: var(--bg-kaisa); -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 同步狀態指示燈 */
        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            z-index: 9999;
            transition: all 0.3s ease;
        }
        .sync-saving { background-color: #F59E0B; box-shadow: 0 0 5px #F59E0B; } /* 儲存中(黃) */
        .sync-done { background-color: #10B981; opacity: 0; } /* 完成(綠 -> 消失) */
        .sync-error { background-color: #EF4444; box-shadow: 0 0 8px #EF4444; } /* 錯誤(紅) */

        #error-msg { display: none; color: red; padding: 20px; font-weight: bold; position: fixed; top:30px; left:0; z-index:9999; background:white; width:100%; border-bottom: 2px solid red; text-align: center;}
    </style>
</head>
<body class="h-[100dvh] w-screen overflow-hidden text-[#4A453C]">

    <div id="sync-status" class="sync-indicator"></div>
    <div id="error-msg"></div>
    <div id="root" class="h-full w-full flex flex-col"></div>

    <script>
        window.onerror = function(msg) {
            document.getElementById('error-msg').style.display = 'block';
            document.getElementById('error-msg').innerText = '⚠️ 錯誤: ' + msg;
            setTimeout(() => document.getElementById('error-msg').style.display = 'none', 5000);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 雲端設定 (改用 Master Key) ---
        const BIN_ID = "6940c08643b1c97be9f11726";
        // 使用您的 X-Master-Key，權限最高，保證能讀寫
        const API_KEY = "$2a$10$KswvGv7VOFlGbWvZCr8W9uZKsQ3rJWGsV3JWj8czKDfCm1E9/c91y"; 
        const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        // --- 內嵌 SVG 圖示 ---
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className="w-3 h-3 text-white"><polyline points="20 6 9 17 4 12"></polyline></svg>;
        const IconPlus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const IconArchive = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></svg>;
        const IconSave = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>;
        const IconArrowLeft = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-6 h-6 text-[#5C5548]"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>;
        const IconTrash = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="w-4 h-4"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const IconClipboard = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="w-12 h-12 mx-auto mb-2"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M9 14l2 2 4-4"></path></svg>;

        function App() {
            // --- 狀態 ---
            const [title, setTitle] = useState(() => {
                const d = new Date();
                return `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
            });
            const [inputText, setInputText] = useState("");
            const [todos, setTodos] = useState([]);
            const [archives, setArchives] = useState([]);
            const [view, setView] = useState("current"); 
            const [isLoading, setIsLoading] = useState(true);

            const isFirstLoad = useRef(true);
            const saveTimeoutRef = useRef(null);

            // --- 雲端同步核心邏輯 ---
            
            // 1. 從雲端讀取資料
            const fetchFromCloud = async () => {
                try {
                    console.log("開始讀取雲端...");
                    const res = await fetch(API_URL, {
                        headers: { "X-Master-Key": API_KEY }
                    });
                    
                    if (!res.ok) {
                        const errText = await res.text();
                        console.error("雲端錯誤:", res.status, errText);
                        throw new Error(`連線錯誤 (${res.status})`);
                    }
                    
                    const json = await res.json();
                    const data = json.record;

                    // 更新本地狀態
                    if (data.title) setTitle(data.title);
                    if (Array.isArray(data.todos)) setTodos(data.todos);
                    if (Array.isArray(data.archives)) setArchives(data.archives);
                    
                    setIsLoading(false);
                    isFirstLoad.current = false;
                } catch (err) {
                    console.error("讀取失敗:", err);
                    alert("⚠️ 無法連線到雲端，將使用離線模式 (" + err.message + ")");
                    setIsLoading(false);
                    isFirstLoad.current = false;
                }
            };

            // 2. 儲存到雲端 (Update)
            const saveToCloud = () => {
                if (isFirstLoad.current) return;

                const indicator = document.getElementById("sync-status");
                indicator.className = "sync-indicator sync-saving"; // 黃燈

                if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);

                saveTimeoutRef.current = setTimeout(async () => {
                    try {
                        const payload = { title, todos, archives };
                        
                        const res = await fetch(API_URL, {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                                "X-Master-Key": API_KEY
                            },
                            body: JSON.stringify(payload)
                        });

                        if (!res.ok) throw new Error("儲存失敗");
                        
                        indicator.className = "sync-indicator sync-done"; // 綠燈
                        setTimeout(() => indicator.className = "sync-indicator", 2000); // 燈滅
                    } catch (err) {
                        console.error("儲存失敗:", err);
                        indicator.className = "sync-indicator sync-error"; // 紅燈
                    }
                }, 1000);
            };

            // --- 生命周期 ---
            useEffect(() => {
                fetchFromCloud();

                const handleVisibilityChange = () => {
                    if (document.visibilityState === 'visible') {
                        const d = new Date();
                        const todayStr = `${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
                        setTitle(prev => {
                            if (/^\d{4}\/\d{2}\/\d{2}$/.test(prev) && prev !== todayStr) return todayStr;
                            return prev;
                        });
                        // 喚醒時也重新同步一次，確保是最新
                        fetchFromCloud();
                    }
                };
                document.addEventListener("visibilitychange", handleVisibilityChange);
                const timer = setInterval(() => { /* 日期檢查 */ }, 60000);

                return () => {
                    document.removeEventListener("visibilitychange", handleVisibilityChange);
                    clearInterval(timer);
                };
            }, []);

            useEffect(() => {
                saveToCloud();
            }, [title, todos, archives]);


            // --- 邏輯操作 ---
            const handleAdd = (e) => {
                e.preventDefault();
                if (!inputText.trim()) return;
                setTodos([...todos, { id: Date.now().toString(), text: inputText.trim(), completed: false }]);
                setInputText("");
            };

            const toggleComplete = (id) => {
                setTodos(todos.map(t => t.id === id ? { ...t, completed: !t.completed } : t));
            };

            const handleArchive = () => {
                if (todos.length === 0) return;
                const record = {
                    id: Date.now().toString(),
                    saveDate: new Date().toLocaleString(),
                    originalTitle: title,
                    items: todos
                };
                setArchives([record, ...archives]);
                
                const d = new Date();
                setTitle(`${d.getFullYear()}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`);
                setTodos([]);
                setView("current");
                alert("已歸檔並同步至雲端！");
            };

            const deleteArchive = (id) => {
                if(confirm("確定刪除此紀錄？")) {
                    setArchives(archives.filter(a => a.id !== id));
                }
            };

            // --- 渲染 ---
            if (isLoading) {
                return (
                    <div className="h-full flex items-center justify-center bg-[#FEF9E7] flex-col text-[#9C9689]">
                        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#F59E0B] mb-4"></div>
                        <p>正在同步雲端資料...</p>
                    </div>
                );
            }

            if (view === 'archive') {
                return (
                    <div className="flex flex-col h-full bg-[#F5F1E0]">
                        <div className="flex-none p-4 bg-[#FEF9E7] shadow-sm flex items-center z-20">
                            <button onClick={() => setView('current')} className="mr-3 p-3 -ml-2 rounded-full hover:bg-[#EAE4D0]">
                                <IconArrowLeft />
                            </button>
                            <h1 className="text-xl font-bold">歷史歸檔</h1>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-24">
                            {archives.length === 0 && <div className="text-center text-[#9C9689] mt-20">暫無歷史紀錄</div>}
                            {archives.map(record => (
                                <div key={record.id} className="bg-white rounded-xl p-5 shadow-sm border border-[#E8E0C5]">
                                    <div className="flex justify-between items-start mb-3 border-b border-[#F0EBE0] pb-2">
                                        <div>
                                            <h3 className="font-bold text-lg">{record.originalTitle}</h3>
                                            <span className="text-xs text-[#9C9689]">{record.saveDate}</span>
                                        </div>
                                        <button onClick={() => deleteArchive(record.id)} className="text-red-400 p-2">
                                            <IconTrash />
                                        </button>
                                    </div>
                                    <ul className="space-y-2">
                                        {(record.items || []).map((item, idx) => (
                                            <li key={idx} className="flex items-start text-[15px]">
                                                <span className={`mr-2 mt-1 text-[10px] ${item.completed ? 'text-[#F59E0B]' : 'text-[#E8E0C5]'}`}>●</span>
                                                <span className={item.completed ? 'text-[#C4BFB0] line-through' : ''}>{item.text}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col h-full bg-[#FEF9E7] relative">
                    <div className="flex-none p-5 z-10">
                        <input 
                            type="text" 
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                            className="w-full text-2xl font-bold text-[#4A453C] bg-transparent border-b-2 border-[#E8E0C5] focus:border-[#F59E0B] focus:outline-none text-center pb-2"
                        />
                    </div>

                    <div className="flex-1 overflow-y-auto px-4 pb-32 no-scrollbar">
                        {todos.length === 0 && (
                            <div className="text-center text-[#9C9689] mt-20 opacity-50">
                                <IconClipboard />
                                <p>新增你的第一件事</p>
                            </div>
                        )}
                        {todos.map((todo, index) => (
                            <div 
                                key={todo.id} 
                                onClick={() => toggleComplete(todo.id)}
                                className={`flex items-start p-4 mb-3 rounded-xl border transition-all cursor-pointer select-none
                                    ${todo.completed ? 'bg-[#F9F6ED] border-transparent opacity-60' : 'bg-white border-[#F0EBE0] shadow-sm active:scale-[0.98]'}`}
                            >
                                <div className="flex flex-col items-center mr-4 pt-1">
                                    <span className="text-[10px] font-mono text-[#C4BFB0] mb-1">{index + 1}</span>
                                    <div className={`w-5 h-5 rounded-full border-2 flex items-center justify-center
                                        ${todo.completed ? 'bg-[#F59E0B] border-[#F59E0B]' : 'border-[#D6CDB8]'}`}>
                                        {todo.completed && <IconCheck />}
                                    </div>
                                </div>
                                <div className={`text-lg leading-snug flex-1 break-all ${todo.completed ? 'line-through text-[#C4BFB0]' : 'text-[#5C5548]'}`}>
                                    {todo.text}
                                </div>
                            </div>
                        ))}
                    </div>

                    <div className="fixed bottom-0 left-0 right-0 bg-[#FEF9E7] border-t border-[#E8E0C5] p-4 pb-8 shadow-[0_-5px_20px_rgba(0,0,0,0.03)] z-50">
                        <div className="max-w-md mx-auto">
                            <form onSubmit={handleAdd} className="flex gap-2 mb-3">
                                <input
                                    type="text"
                                    value={inputText}
                                    onChange={(e) => setInputText(e.target.value)}
                                    placeholder="輸入待辦..."
                                    className="flex-1 bg-white text-[#4A453C] rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-[#F59E0B]/50 text-lg shadow-sm border border-[#E8E0C5]"
                                />
                                <button type="submit" className="bg-[#F59E0B] text-white w-12 h-12 rounded-xl flex items-center justify-center shadow-lg active:scale-90 transition-transform flex-shrink-0">
                                    <IconPlus />
                                </button>
                            </form>
                            
                            <div className="flex justify-between px-1">
                                <button onClick={() => setView('archive')} className="text-[#9C9689] text-sm flex items-center gap-1 py-2 px-3 rounded-lg hover:bg-[#F2EFE6]">
                                    <IconArchive /> 紀錄
                                </button>
                                <button onClick={handleArchive} className="text-[#B58900] font-bold text-sm flex items-center gap-1 py-2 px-3 rounded-lg bg-[#FFF2CC]">
                                    <IconSave /> 歸檔
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
